build-cpp:
  stage: build
  tags:
   - cpp
   - hpcagainstcorona
  before_script:
    - apt -qq -y install libeigen3-dev
  script:
    - cd cpp
    - mkdir build && cd build
    - cmake ..
    - cmake --build .
  artifacts:
    expire_in: 2 hrs
    paths:
      - cpp/build/

build-py:
  tags:
   - cpp
   - hpcagainstcorona
  stage: build
  before_script:
    - apt -qq -y install python3.7-venv python3-venv libeigen3-dev
    - cd pycode
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install scikit-build
  script:
    - python3 setup.py bdist_wheel
  artifacts:
    paths:
      - pycode/dist/*.whl

# run tests using the binary built before
test-cpp:
  tags:
   - cpp
   - hpcagainstcorona
  stage: test
  dependencies:
    - build-cpp
  script:
    - cd cpp/build/tests
    - ./runUnitTests --gtest_output="xml:report.xml"
  artifacts:
    reports:
      junit: cpp/build/tests/report.xml

build-js:
  tags:
   - npm
   - hpcagainstcorona
  stage: build
  before_script:
     - npm install
     - npm install -g grunt-cli
  script:
    - grunt
  artifacts:
    paths:
      - dist/

www:
  tags:
   - native
   - hpcagainstcorona
  stage: deploy
  dependencies:
    - build-js
  script:
    - cp -r dist/* /var/www/html
  only:
    - master
