<!doctype html>
<header>
    <script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
</header>
<html>

<body>
    <div id="chart1"></div>
    <script src="secirjs.js"></script>
    <script>
        function toArray(vector) {
            var arr = [];
            for (var i = 0; i < vector.size(); ++i) {
                arr.push(vector.get(i));
            }
            return arr;
        }

        function plot_data(secir_data) {

            var plot_type = "linear";

            var placeholder = document.getElementById('chart1');
            Plotly.newPlot(placeholder,
                [
                    {
                        x: secir_data.t,
                        y: secir_data.nb_sus,
                        name: "susceptible"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_exp,
                        name: "exposed"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_inf,
                        name: "infections"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_rec,
                        name: "immune / recovered"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_car,
                        name: "carrying"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_hosp,
                        name: "hospitalized"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_icu,
                        name: "ICU"
                    },
                    {
                        x: secir_data.t,
                        y: secir_data.nb_dead,
                        name: "dead"
                    }
                ],
                {
                    margin: { t: 0 },
                    xaxis: {
                        title: "#Days since t0"
                    },
                    yaxis: {
                        type: plot_type,
                        autorange: true,
                        title: 'Number',
                    }
                }
            );

        }



        secirjs().then(function (secir) {
            var times = new secir.StageTimes()
            times.set_incubation(5.2) // R_2 ^ (-1) + R_3 ^ (-1)
            times.set_infectious_mild(6.) // 4 - 14(=R4 ^ (-1))
            times.set_serialinterval(4.2) // 4 - 4.4 // R_2^(-1)+0.5*R_3^(-1)
            times.set_hospitalized_to_home(12.) // 7 - 16(=R5 ^ (-1))
            times.set_home_to_hospitalized(5.) // 2.5 - 7(=R6 ^ (-1))
            times.set_hospitalized_to_icu(2.) // 1 - 3.5(=R7 ^ (-1))
            times.set_icu_to_home(8.) // 5 - 16(=R8 ^ (-1))
            times.set_infectious_asymp(6.2) // (= R9 ^ (-1)= R_3 ^ (-1) + 0.5 * R_4 ^ (-1))
            times.set_icu_to_death(5.) // 3.5 - 7(=R5 ^ (-1))

            var probs = new secir.Probabilities()
            probs.set_asymp_per_infectious(0.09) // 0.01 - 0.16
            probs.set_risk_from_symptomatic(0.25) // 0.05 - 0.5
            probs.set_hospitalized_per_infectious(0.2) // 0.1 - 0.35
            probs.set_icu_per_hospitalized(0.25) // 0.15 - 0.4
            probs.set_dead_per_icu(0.3) // 0.15 - 0.77

            var people = new secir.Populations()
            people.set_total_t0(10000)
            people.set_exposed_t0(100)
            people.set_carrier_t0(50)
            people.set_infectious_t0(50)
            people.set_hospital_t0(20)
            people.set_icu_t0(10)
            people.set_recovered_t0(10)
            people.set_dead_t0(0)

            // set the params required fseciror the simulation
            var param = new secir.SecirParams()
            param.times = times
            param.probabilities = probs
            param.populations = people
            times.delete();
            probs.delete();
            people.delete();

            var params = new secir.VectorSecirParams();
            params.push_back(param);
            param.delete();

            secir.print_secir_params(params);

            cont_freq_matrix = new secir.ContactFrequencyMatrix()
            cont_freq_matrix.set_cont_freq(0.5, 0, 0) // 0.2 - 0.75

            // emulate some mitigations
            var d1 = new secir.Damping(23., 0.8);
            var d2 = new secir.Damping(25., 0.75);
            var d3 = new secir.Damping(27., 0.7);
            cont_freq_matrix.add_damping(d1, 0, 0);
            cont_freq_matrix.add_damping(d2, 0, 0);
            cont_freq_matrix.add_damping(d3, 0, 0);
            d1.delete();
            d2.delete();
            d3.delete();

            result = secir.simulate(0., 100., 0.1, cont_freq_matrix, params)
            params.delete();
            cont_freq_matrix.delete();

            // copy data to plain javascript arrays
            secir_data = {
                t: toArray(result.t),
                nb_sus: toArray(result.nb_sus),
                nb_exp: toArray(result.nb_exp),
                nb_car: toArray(result.nb_car),
                nb_inf: toArray(result.nb_inf),
                nb_hosp: toArray(result.nb_hosp),
                nb_icu: toArray(result.nb_icu),
                nb_rec: toArray(result.nb_rec),
                nb_dead: toArray(result.nb_dead)
            };
            result.delete();

            plot_data(secir_data);
        });
    </script>
</body>

</html>